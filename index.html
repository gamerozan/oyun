<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>2.5D Araba Oyunu</title>
<style>
  body {
    margin: 0;
    overflow: hidden;
    background: #dff6ff;
    font-family: Arial;
  }
  canvas {
    display: block;
    background: linear-gradient(#cceeff, #88cc88);
  }
  #ui {
    position: fixed;
    bottom: 10px;
    right: 10px;
    width: 260px;
    background: rgba(0,0,0,0.6);
    color: white;
    padding: 8px;
    border-radius: 10px;
    font-size: 14px;
  }
  #chat {
    height: 120px;
    overflow-y: auto;
    background: rgba(255,255,255,0.1);
    margin-bottom: 5px;
    padding: 5px;
  }
  #msg {
    width: 100%;
    box-sizing: border-box;
  }
  #fps {
    position: fixed;
    top: 10px;
    left: 10px;
    color: black;
    background: rgba(255,255,255,0.7);
    padding: 5px 8px;
    border-radius: 6px;
    font-weight: bold;
  }
</style>
</head>
<body>

<canvas id="game"></canvas>

<div id="fps">FPS: 0</div>

<div id="ui">
  <div id="chat"></div>
  <input id="msg" placeholder="Mesaj yaz ve Enter'a bas">
</div>

<script>
/* ================= AYARLAR ================= */

// ðŸ” BURAYA YENÄ° PIESOCKET KEY
const PIE_API_KEY = "mHmfRjKDZuuNVZJTv39ElR0az0P8g99OJNhskSCY";

// oda adÄ± (aynÄ± oda = aynÄ± oyun)
const ROOM = "oda1";

/* ========================================== */

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

canvas.width = innerWidth;
canvas.height = innerHeight;

const id = Math.random().toString(36).substr(2, 5);
const name = "Oyuncu_" + id;

let players = {};
let keys = {};
let lastTime = performance.now();
let fps = 0;

/* =============== SOCKET ================== */
const ws = new WebSocket(
  `wss://free.blr2.piesocket.com/v3/${ROOM}?api_key=${PIE_API_KEY}&notify_self=1`
);

ws.onopen = () => {
  send({ type: "join", id, name });
};

ws.onmessage = (e) => {
  const data = JSON.parse(e.data);

  if (data.type === "join") {
    players[data.id] = {
      x: Math.random() * 500,
      y: Math.random() * 300,
      name: data.name
    };
    chat(`${data.name} oyuna girdi`);
  }

  if (data.type === "leave") {
    chat(`${players[data.id]?.name} oyundan Ã§Ä±ktÄ±`);
    delete players[data.id];
  }

  if (data.type === "move" && players[data.id]) {
    players[data.id].x = data.x;
    players[data.id].y = data.y;
  }

  if (data.type === "chat") {
    chat(`${data.name}: ${data.text}`);
  }
};

window.addEventListener("beforeunload", () => {
  send({ type: "leave", id });
});

/* =============== CHAT ================== */
const chatBox = document.getElementById("chat");
const msgInput = document.getElementById("msg");

msgInput.addEventListener("keydown", e => {
  if (e.key === "Enter" && msgInput.value.trim()) {
    send({ type: "chat", name, text: msgInput.value });
    msgInput.value = "";
  }
});

function chat(text) {
  chatBox.innerHTML += text + "<br>";
  chatBox.scrollTop = chatBox.scrollHeight;
}

/* =============== KONTROLLER ================== */
document.addEventListener("keydown", e => keys[e.key] = true);
document.addEventListener("keyup", e => keys[e.key] = false);

/* =============== OYUN ================== */
function update(dt) {
  if (!players[id]) return;

  let p = players[id];
  const speed = 200 * dt;

  if (keys["w"]) p.y -= speed;
  if (keys["s"]) p.y += speed;
  if (keys["a"]) p.x -= speed;
  if (keys["d"]) p.x += speed;

  send({ type: "move", id, x: p.x, y: p.y });
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  for (let pid in players) {
    let p = players[pid];

    // araba
    ctx.fillStyle = pid === id ? "red" : "blue";
    ctx.fillRect(p.x, p.y, 40, 20);

    // isim
    ctx.fillStyle = "black";
    ctx.fillText(p.name, p.x, p.y - 5);
  }
}

function loop(time) {
  const dt = (time - lastTime) / 1000;
  lastTime = time;

  fps = Math.round(1 / dt);
  document.getElementById("fps").innerText = "FPS: " + fps;

  update(dt);
  draw();
  requestAnimationFrame(loop);
}

requestAnimationFrame(loop);

/* =============== YARDIMCI ================== */
function send(obj) {
  ws.readyState === 1 && ws.send(JSON.stringify(obj));
}
</script>
</body>
</html>
