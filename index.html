<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Multiplayer Araba Oyunu</title>
<style>
body {
  margin: 0;
  background: #eaf6ff;
  font-family: Arial, sans-serif;
  overflow: hidden;
}
#login {
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, #eaf6ff, #ffffff);
  display: flex;
  align-items: center;
  justify-content: center;
}
#login div {
  background: white;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,.15);
}
#login input, #login button {
  width: 100%;
  margin: 5px 0;
  padding: 8px;
}
canvas {
  display: block;
}
#chat {
  position: absolute;
  right: 10px;
  bottom: 10px;
  width: 250px;
  background: rgba(255,255,255,0.9);
  border-radius: 8px;
  font-size: 12px;
}
#messages {
  height: 120px;
  overflow-y: auto;
  padding: 5px;
}
#chat input {
  width: 100%;
  box-sizing: border-box;
}
#fps {
  position: absolute;
  left: 10px;
  top: 10px;
  font-weight: bold;
}
</style>
</head>

<body>

<div id="login">
  <div>
    <h3>üèÅ Araba Oyunu</h3>
    <input id="nick" placeholder="Nick">
    <input id="room" placeholder="Oda ≈ûifresi">
    <button onclick="joinGame()">Oyuna Gir</button>
  </div>
</div>

<canvas id="game"></canvas>

<div id="chat" hidden>
  <div id="messages"></div>
  <input id="chatInput" placeholder="Chat..." />
</div>

<div id="fps">FPS: 0</div>

<script>
const API_KEY = "CHAKAsMULcSYP514xXMuX50m1ZF8MgjSpMpIvTfo";
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let ws;
let myId = Math.random().toString(36).slice(2);
let nick = "";
let room = "";
let players = {};
let keys = {};
let lastTime = performance.now();
let fps = 0;

function joinGame() {
  nick = document.getElementById("nick").value;
  room = document.getElementById("room").value;
  if (!nick || !room) return;

  document.getElementById("login").style.display = "none";
  document.getElementById("chat").hidden = false;

  ws = new WebSocket(
    `wss://${API_KEY}.piesocket.com/v3/${room}?api_key=${API_KEY}&notify_self=1`
  );

  ws.onopen = () => {
    send({type:"join", id:myId, nick});
    players[myId] = {x:200,y:200,nick};
    addMsg(`üü¢ ${nick} girdi`);
  };

  ws.onmessage = e => {
    const d = JSON.parse(e.data);
    if (d.type === "join" && !players[d.id]) {
      players[d.id] = {x:200,y:200,nick:d.nick};
      addMsg(`üü¢ ${d.nick} girdi`);
    }
    if (d.type === "leave") {
      if (players[d.id]) {
        addMsg(`üî¥ ${players[d.id].nick} √ßƒ±ktƒ±`);
        delete players[d.id];
      }
    }
    if (d.type === "move" && players[d.id]) {
      players[d.id].x = d.x;
      players[d.id].y = d.y;
    }
    if (d.type === "chat") {
      addMsg(`${d.nick}: ${d.msg}`);
    }
  };
}

function send(obj){ ws.send(JSON.stringify(obj)); }

function addMsg(t){
  const m = document.getElementById("messages");
  m.innerHTML += t+"<br>";
  m.scrollTop = m.scrollHeight;
}

document.getElementById("chatInput").addEventListener("keydown", e=>{
  if(e.key==="Enter"){
    send({type:"chat", nick, msg:e.target.value});
    e.target.value="";
  }
});

window.addEventListener("keydown",e=>keys[e.key]=true);
window.addEventListener("keyup",e=>keys[e.key]=false);

function loop(t){
  fps = Math.round(1000/(t-lastTime));
  lastTime = t;
  document.getElementById("fps").innerText = "FPS: "+fps;

  if(players[myId]){
    if(keys["w"]) players[myId].y-=4;
    if(keys["s"]) players[myId].y+=4;
    if(keys["a"]) players[myId].x-=4;
    if(keys["d"]) players[myId].x+=4;

    send({type:"move", id:myId, x:players[myId].x, y:players[myId].y});
  }

  ctx.fillStyle="#eaf6ff";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  for(const id in players){
    const p=players[id];
    ctx.fillStyle="red";
    ctx.fillRect(p.x,p.y,40,20);
    ctx.fillStyle="black";
    ctx.fillText(p.nick,p.x,p.y-5);
  }

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>

</body>
</html>
